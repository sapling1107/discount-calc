<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta property="og:title" content="折扣計算器">
  <meta property="og:description" content="輸入原價、特價或折扣率，任兩個即可自動算出第三個。支援多行與折數提示！">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://sapling1107.github.io/discount-calc/">
  <meta property="og:image" content="https://sapling1107.github.io/discount-calc/og-image.png">
  <title>折扣計算器</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; max-width: 700px; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
    input { width: 90px; text-align: right; }
    .note { color: #555; font-size: 0.9em; margin-left: 5px; }
    button { margin-top: 10px; margin-right: 5px; }
  </style>
</head>
<body>
  <h2>折扣計算器（三欄位互算，多行版）</h2>

  <table id="calcTable">
    <thead>
      <tr>
        <th>原價</th>
        <th>特價</th>
        <th>折扣率（可輸入 85 或 0.85）</th>
        <th>折數提示</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="number" step="0.01" min="0"></td>
        <td><input type="number" step="0.01" min="0"></td>
        <td><input type="number" step="0.01" min="0"></td>
        <td class="note"></td>
      </tr>
    </tbody>
  </table>

  <button onclick="addRow()">新增一行</button>
  <button onclick="clearAll()">清空所有行</button>

  <script>
    const has = v => !Number.isNaN(v);

    // 折扣輸入轉百分比（0.85 -> 85；85 -> 85）
    function toPercent(val) {
      if (!has(val)) return NaN;
      if (val <= 1.5) return val * 100;
      return val;
    }
    // 折扣輸入轉比例（85 -> 0.85；0.85 -> 0.85）
    function toRatio(val) {
      if (!has(val)) return NaN;
      if (val <= 1.5) return val;
      return val / 100;
    }

    function setNote(noteCell, percent) {
      if (has(percent)) {
        noteCell.textContent = "約 " + (percent / 10).toFixed(1) + " 折";
      } else {
        noteCell.textContent = "";
      }
    }

    function scheduleRecalc(input) {
      const row = input.closest("tr");
      // 記錄最後編輯欄位（0: 原價, 1: 特價, 2: 折扣）
      row.dataset.lastEdited = [...row.querySelectorAll("input")].indexOf(input);

      // debounce：避免輸入過程被打斷
      clearTimeout(row._timer);
      row._timer = setTimeout(() => recalcRow(row), 300);
    }

    function recalcRow(row) {
      const inputs = row.querySelectorAll("input");
      const noteCell = row.querySelector(".note");
      let original = parseFloat(inputs[0].value);
      let sale     = parseFloat(inputs[1].value);
      let discRaw  = parseFloat(inputs[2].value);

      const filled = [has(original), has(sale), has(discRaw)].filter(Boolean).length;

      // 少於兩個值就只更新折數提示
      if (filled < 2) {
        setNote(noteCell, has(discRaw) ? toPercent(discRaw) : NaN);
        return;
      }
      if (has(original) && original === 0) { setNote(noteCell, NaN); return; }

      const last = parseInt(row.dataset.lastEdited ?? "0", 10);

      // ---- 計算策略 ----
      // 當三格都有值：以「最後編輯」為主，覆寫最不合理的那一格
      // 規則：
      //  - 最後改「折扣」(2)：用 原價 × 折扣 → 覆寫「特價」
      //  - 最後改「特價」(1)：有原價 → 算折扣；否則用折扣→算原價
      //  - 最後改「原價」(0)：有折扣 → 算特價；否則用特價→算折扣
      if (filled === 3) {
        if (last === 2) {
          const ratio = toRatio(discRaw);
          if (has(ratio)) {
            sale = original * ratio;
            inputs[1].value = sale.toFixed(2);
          }
        } else if (last === 1) {
          if (has(original) && original > 0) {
            const percent = (sale / original) * 100;
            inputs[2].value = percent.toFixed(2);
          } else {
            const ratio = toRatio(discRaw);
            if (has(ratio) && ratio > 0) {
              original = sale / ratio;
              inputs[0].value = original.toFixed(2);
            }
          }
        } else { // last === 0
          const ratio = toRatio(discRaw);
          if (has(ratio)) {
            sale = original * ratio;
            inputs[1].value = sale.toFixed(2);
          } else if (has(original) && original > 0) {
            const percent = (sale / original) * 100;
            inputs[2].value = percent.toFixed(2);
          }
        }
      } else {
        // 只有兩格：補第三格
        // 原價+特價 → 折扣
        if (has(original) && has(sale) && !has(discRaw)) {
          const percent = (sale / original) * 100;
          inputs[2].value = percent.toFixed(2);
        }
        // 原價+折扣 → 特價
        else if (has(original) && !has(sale) && has(discRaw)) {
          const ratio = toRatio(discRaw);
          if (has(ratio)) inputs[1].value = (original * ratio).toFixed(2);
          inputs[2].value = toPercent(discRaw).toFixed(2);
        }
        // 特價+折扣 → 原價
        else if (!has(original) && has(sale) && has(discRaw)) {
          const ratio = toRatio(discRaw);
          if (has(ratio) && ratio > 0) inputs[0].value = (sale / ratio).toFixed(2);
          inputs[2].value = toPercent(discRaw).toFixed(2);
        }
      }

      // 更新折數提示（以折扣欄為準）
      const discPercent = parseFloat(inputs[2].value);
      setNote(noteCell, has(discPercent) ? discPercent : NaN);
    }

    // 綁定初始列事件
    function bindRow(row) {
      const inputs = row.querySelectorAll("input");
      inputs.forEach(inp => {
        inp.addEventListener("input", () => scheduleRecalc(inp));
        inp.addEventListener("focus", () => { row.dataset.lastEdited = [...inputs].indexOf(inp); });
      });
    }
    bindRow(document.querySelector("#calcTable tbody tr"));

    function addRow() {
      const tbody = document.querySelector("#calcTable tbody");
      const tr = document.createElement("tr");
      for (let i = 0; i < 3; i++) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.step = "0.01";
        input.min = "0";
        td.appendChild(input);
        tr.appendChild(td);
      }
      const noteTd = document.createElement("td");
      noteTd.className = "note";
      tr.appendChild(noteTd);
      tbody.appendChild(tr);
      bindRow(tr);
    }

    function clearAll() {
      const tbody = document.querySelector("#calcTable tbody");
      tbody.innerHTML = "";
      addRow();
    }
  </script>
</body>
</html>
