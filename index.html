<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta property="og:title" content="折扣計算器">
  <meta property="og:description" content="輸入原價、特價或折扣率，任兩個即可自動算出第三個。支援多行與折數提示！">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://sapling1107.github.io/discount-calc/">
  <meta property="og:image" content="https://sapling1107.github.io/discount-calc/og-image.png">
  <title>折扣計算器</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; max-width: 700px; }
    th, td { border: 1px solid #aaa; padding: 8px; text-align: center; }
    input { width: 90px; text-align: right; }
    .note { color: #555; font-size: 0.9em; margin-left: 5px; }
    button { margin-top: 10px; margin-right: 5px; }
  </style>
</head>
<body>
  <h2>折扣計算器（三欄位互算，多行版）</h2>

  <table id="calcTable">
    <thead>
      <tr>
        <th>原價</th>
        <th>特價</th>
        <th>折扣率（可輸入 85 或 0.85）</th>
        <th>折數提示</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td><input type="number" step="0.01" min="0" oninput="recalc(this)"></td>
        <td><input type="number" step="0.01" min="0" oninput="recalc(this)"></td>
        <td><input type="number" step="0.01" min="0" oninput="recalc(this)"></td>
        <td class="note"></td>
      </tr>
    </tbody>
  </table>

  <button onclick="addRow()">新增一行</button>
  <button onclick="clearAll()">清空所有行</button>

  <script>
    const has = v => !Number.isNaN(v);

    // 將使用者輸入的折扣解讀成「百分比數字」：0.85 -> 85，85 -> 85
    function toPercent(val) {
      if (!has(val)) return NaN;
      if (val <= 1.5) return val * 100; // 視為比例
      return val; // 視為百分比
    }
    // 將折扣轉為「乘數比例」：85(%) -> 0.85，0.85 -> 0.85
    function toRatio(val) {
      if (!has(val)) return NaN;
      if (val <= 1.5) return val;       // 已是比例
      return val / 100;                 // 由百分比轉比例
    }

    function setNote(noteCell, percent) {
      if (has(percent)) {
        noteCell.textContent = "約 " + (percent / 10).toFixed(1) + " 折";
      } else {
        noteCell.textContent = "";
      }
    }

    function recalc(input) {
      const row = input.closest("tr");
      const inputs = row.querySelectorAll("input");
      const noteCell = row.querySelector(".note");

      let original = parseFloat(inputs[0].value);
      let sale     = parseFloat(inputs[1].value);
      let discRaw  = parseFloat(inputs[2].value); // 可能是 85 或 0.85

      const filled = [has(original), has(sale), has(discRaw)].filter(Boolean).length;

      // 少於兩個值就不算
      if (filled < 2) { setNote(noteCell, has(discRaw) ? toPercent(discRaw) : NaN); return; }
      // 防止除以 0
      if (has(original) && original === 0) { setNote(noteCell, NaN); return; }

      // Case 1：原價 + 特價 → 算折扣率（百分比）
      if (has(original) && has(sale) && !has(discRaw)) {
        if (original > 0) {
          const percent = (sale / original) * 100;
          inputs[2].value = percent.toFixed(2);       // 統一顯示為百分比
          setNote(noteCell, percent);
        }
        return;
      }

      // Case 2：原價 + 折扣率 → 算特價
      if (has(original) && !has(sale) && has(discRaw)) {
        const ratio = toRatio(discRaw);
        if (has(ratio)) {
          sale = original * ratio;
          inputs[1].value = sale.toFixed(2);
          const percent = toPercent(discRaw);
          inputs[2].value = percent.toFixed(2);       // 將 0.85 轉成 85 顯示
          setNote(noteCell, percent);
        }
        return;
      }

      // Case 3：特價 + 折扣率 → 算原價
      if (!has(original) && has(sale) && has(discRaw)) {
        const ratio = toRatio(discRaw);
        if (has(ratio) && ratio > 0) {
          original = sale / ratio;
          inputs[0].value = original.toFixed(2);
          const percent = toPercent(discRaw);
          inputs[2].value = percent.toFixed(2);
          setNote(noteCell, percent);
        }
        return;
      }

      // 三格都有值時，只更新折數提示（以折扣欄為準）
      const percent = toPercent(discRaw);
      setNote(noteCell, percent);
    }

    function addRow() {
      const tbody = document.getElementById("calcTable").getElementsByTagName("tbody")[0];
      const newRow = document.createElement("tr");

      for (let i = 0; i < 3; i++) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.step = "0.01";
        input.oninput = function () { recalc(this); };
        td.appendChild(input);
        newRow.appendChild(td);
      }

      const noteTd = document.createElement("td");
      noteTd.className = "note";
      newRow.appendChild(noteTd);

      tbody.appendChild(newRow);
    }

    function clearAll() {
      const tbody = document.getElementById("calcTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = ""; // 清空表格內容

      // 加回一行空白輸入
      const row = document.createElement("tr");
      for (let i = 0; i < 3; i++) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.type = "number";
        input.step = "0.01";
        input.oninput = function () { recalc(this); };
        td.appendChild(input);
        row.appendChild(td);
      }
      const noteTd = document.createElement("td");
      noteTd.className = "note";
      row.appendChild(noteTd);

      tbody.appendChild(row);
    }
  </script>
</body>
</html>
